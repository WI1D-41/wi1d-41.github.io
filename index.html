<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MAX MiniApp · Biometric (Spec-Exact)</title>
  <script src="https://st.max.ru/js/max-web-app.js"></script>
  <style>
    :root{--bg:#0b0f17;--card:#121826;--muted:#8aa0b4}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#e8f0f8}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    .card{background:#121826;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:#1f2d3d;border:1px solid #2b3a51;color:#e8f0f8;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:linear-gradient(90deg,#1b5cff,#00b4ff);border:none}
    input{width:100%;background:#0e1422;color:#e8f0f8;border:1px solid #263242;border-radius:10px;padding:10px 12px}
    .pill{border:1px solid #2b3a51;color:var(--muted);border-radius:999px;padding:4px 8px;font-size:12px}
    .pre{white-space:pre-wrap;word-break:break-word;background:#0a0f18;border:1px solid #1f2b3d;border-radius:10px;padding:12px;min-height:96px}
    .h{font-weight:700;margin:6px 0 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="h">Биометрия · MAX (по спецификации)</div>
      <div class="row">
        <span class="pill" id="pill-bridge">bridge: –</span>
        <span class="pill" id="pill-type">type: –</span>
        <span class="pill" id="pill-access">access: –</span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:8px">
        <button class="btn primary" id="btn-flow">Флоу</button>
        <button class="btn" id="btn-init">init()</button>
        <button class="btn" id="btn-request">requestAccess()</button>
        <button class="btn" id="btn-auth">authenticate()</button>
        <button class="btn" id="btn-settings">openSettings()</button>
      </div>
      <div class="row" style="gap:8px;margin-top:8px">
        <input id="in-token" placeholder="biometricToken (пусто — удалить)" value="demo-token" />
        <button class="btn" id="btn-update">updateBiometricToken()</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="h" style="margin:0">Состояние</div>
        <button class="btn" id="btn-refresh">Обновить</button>
      </div>
      <pre class="pre" id="state">{}</pre>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="h" style="margin:0">Логи</div>
        <button class="btn" id="btn-clear">Очистить</button>
      </div>
      <pre class="pre" id="log"></pre>
    </div>
  </div>

  <script>
  (function(){
    const q=(s,r=document)=>r.querySelector(s);
    const log=q('#log'), stateEl=q('#state');
    const pillBridge=q('#pill-bridge'), pillType=q('#pill-type'), pillAccess=q('#pill-access');
    const WebApp=window.WebApp; const BM=WebApp && WebApp.BiometricManager;

    // Сообщаем клиенту, что миниапп готов
    try{ WebApp && WebApp.ready && WebApp.ready(); }catch(e){}

    pillBridge.textContent='bridge: '+(BM?'present':'none');

    const logLn=(m)=>{ const ts=new Date().toISOString().replace('T',' ').slice(0,19); log.textContent+=`[${ts}] ${m}\n`; log.scrollTop=log.scrollHeight; };
    const asMaybe=async(fn)=>{ const r=fn(); return (r && typeof r.then==='function')? await r : r; };

    const readState=()=>{
      if(!BM) return { error:'BiometricManager недоступен (откройте в MAX)' };
      const s={};
      ['isInited','isBiometricAvailable','biometricType','deviceId','isAccessRequested','isAccessGranted','isBiometricTokenSaved'].forEach(k=>{
        try{ s[k]=BM[k]; }catch{ s[k]=undefined; }
      });
      return s;
    };
    const refresh=()=>{
      const s=readState();
      stateEl.textContent=JSON.stringify(s,null,2);
      const t=Array.isArray(s.biometricType)?s.biometricType.join(','):String(s.biometricType||'');
      pillType.textContent='type: '+(t||'–');
      pillAccess.textContent='access: '+(s.isAccessGranted?'granted':(s.isAccessRequested?'requested':'none'));
      return s;
    };
    const ensureInit=async()=>{
      if(!BM){ logLn('❗ BiometricManager недоступен'); return false; }
      if(!BM.isInited){
        try{ await asMaybe(()=>BM.init()); logLn('ℹ️ init() выполнен автоматически'); }
        catch(e){ logLn('❌ init() ошибка: '+String(e)); refresh(); return false; }
      }
      return true;
    };

    const btnFlow=q('#btn-flow'), btnInit=q('#btn-init'), btnRequest=q('#btn-request'), btnAuth=q('#btn-auth');
    const btnSettings=q('#btn-settings'), btnUpdate=q('#btn-update'), btnRefresh=q('#btn-refresh'), btnClear=q('#btn-clear');
    const inToken=q('#in-token');

    btnClear.onclick=()=>log.textContent='';
    btnRefresh.onclick=refresh;

    btnInit.onclick=async()=>{
      if(!BM) return logLn('❗ BiometricManager недоступен');
      try{ await asMaybe(()=>BM.init()); logLn('✅ init()'); } catch(e){ logLn('❌ init() '+String(e)); }
      refresh();
    };
    btnRequest.onclick=async()=>{
      if(!await ensureInit()) return;
      try{ await asMaybe(()=>BM.requestAccess()); logLn('✅ requestAccess()'); } catch(e){ logLn('❌ requestAccess() '+String(e)); }
      refresh();
    };
    btnUpdate.onclick=async()=>{
      if(!await ensureInit()) return;
      try{ const r=await asMaybe(()=>BM.updateBiometricToken(inToken.value)); logLn('✅ updateBiometricToken → '+JSON.stringify(r)); } catch(e){ logLn('❌ updateBiometricToken() '+String(e)); }
      refresh();
    };
    btnAuth.onclick=async()=>{
      if(!await ensureInit()) return;
      try{ const r=await asMaybe(()=>BM.authenticate()); logLn('✅ authenticate() → '+JSON.stringify(r)); } catch(e){ logLn('❌ authenticate() '+String(e)); }
      refresh();
    };
    btnSettings.onclick=async()=>{
      if(!BM) return logLn('❗ BiometricManager недоступен');
      try{ await asMaybe(()=>BM.openSettings()); logLn('ℹ️ openSettings() вызвано (клиент может закрыть миниапп)'); } catch(e){ logLn('❌ openSettings() '+String(e)); }
      refresh();
    };

    btnFlow.onclick=async()=>{
      await btnInit.onclick();
      await btnRequest.onclick();
      const s=refresh();
      if(!s.isBiometricTokenSaved) await btnUpdate.onclick();
      await btnAuth.onclick();
    };

    refresh();
  })();
  </script>
</body>
</html>
