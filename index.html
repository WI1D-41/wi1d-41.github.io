<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAX MiniApp Biometric Demo</title>
  <script src="https://st.max.ru/js/max-web-app.js"></script>
  <style>
    body { font-family: sans-serif; background:#0b0f17; color:#f0f0f0; margin:0; padding:16px; }
    h1 { text-align:center; }
    .card { background:#121826; padding:16px; border-radius:12px; margin-bottom:16px; }
    .btn { padding:8px 12px; margin:4px 0; border:none; border-radius:8px; cursor:pointer;
           background:#1b5cff; color:white; font-weight:500; }
    .btn.small { font-size:12px; padding:4px 8px; }
    input { width:100%; padding:8px; border-radius:8px; border:1px solid #2b3a51;
            background:#0e1422; color:#e8f0f8; margin:4px 0; }
    pre { white-space:pre-wrap; word-break:break-word; background:#0a0f18;
          border:1px solid #1f2b3d; padding:8px; border-radius:8px; max-height:200px; overflow:auto; }
  </style>
</head>
<body>
  <h1>BiometricManager Demo</h1>

  <div class="card">
    <h3>Методы</h3>
    <button class="btn" onclick="callInit()">init()</button><br/>
    <input id="reason1" placeholder="reason (опц.)"/>
    <button class="btn" onclick="callRequest()">requestAccess()</button><br/>
    <input id="reason2" placeholder="reason (опц.)"/>
    <button class="btn" onclick="callAuth()">authenticate()</button><br/>
    <input id="token" placeholder="token (пусто = удалить)"/>
    <input id="reason3" placeholder="reason (опц.)"/>
    <button class="btn" onclick="callUpdate()">updateBiometricToken()</button><br/>
    <button class="btn" onclick="callSettings()">openSettings()</button><br/>
    <button class="btn" onclick="fullFlow()">Полный флоу</button>
  </div>

  <div class="card">
    <h3>Состояние</h3>
    <button class="btn small" onclick="refreshState()">Обновить</button>
    <pre id="state"></pre>
  </div>

  <div class="card">
    <h3>Логи</h3>
    <button class="btn small" onclick="clearLog()">Очистить</button>
    <pre id="log"></pre>
  </div>

<script>
const WebApp = window.WebApp;
const BM = WebApp?.BiometricManager;
try { WebApp?.ready?.(); } catch{}

function log(m){ const ts=new Date().toISOString().slice(11,19);
  logEl.textContent += `[${ts}] ${m}\n`; logEl.scrollTop=logEl.scrollHeight;}
function pretty(v){ try{return JSON.stringify(v,null,2);}catch{return String(v);} }
const logEl=document.getElementById("log");
const stateEl=document.getElementById("state");

function readState(){
  if(!BM) return {error:"BiometricManager недоступен"};
  return {
    isInited:BM.isInited,
    isBiometricAvailable:BM.isBiometricAvailable,
    isAccessRequested:BM.isAccessRequested,
    isAccessGranted:BM.isAccessGranted,
    isBiometricTokenSaved:BM.isBiometricTokenSaved,
    biometricType:BM.biometricType,
    deviceId:BM.deviceId
  };
}
function refreshState(){ stateEl.textContent=pretty(readState()); }
function clearLog(){ logEl.textContent=""; }

async function ensureInit(){
  if(!BM) throw new Error("BiometricManager недоступен");
  if(!BM.isInited){ await BM.init(); log("init() выполнен авто"); }
}

async function callInit(){ try{ await BM.init(); log("✅ init()"); }catch(e){ log("❌ init "+e);} refreshState(); }
async function callRequest(){
  try{ await ensureInit();
    const reason=document.getElementById("reason1").value;
    const r=reason?await BM.requestAccess(reason):await BM.requestAccess();
    log("✅ requestAccess "+pretty(r));
  }catch(e){ log("❌ requestAccess "+e);} refreshState(); }
async function callAuth(){
  try{ await ensureInit();
    const reason=document.getElementById("reason2").value;
    const r=reason?await BM.authenticate(reason):await BM.authenticate();
    log("✅ authenticate "+pretty(r));
  }catch(e){ log("❌ authenticate "+e);} refreshState(); }
async function callUpdate(){
  try{ await ensureInit();
    const token=document.getElementById("token").value;
    const reason=document.getElementById("reason3").value;
    let r;
    try{ r=await BM.updateBiometricToken(token||null, reason);}catch{
      r=await BM.updateBiometricToken(token||"");
    }
    log("✅ updateBiometricToken "+pretty(r));
  }catch(e){ log("❌ updateBiometricToken "+e);} refreshState(); }
async function callSettings(){
  try{ await ensureInit(); await BM.openSettings();
    log("ℹ️ openSettings вызван (клиент может закрыть миниапп)");
  }catch(e){ log("❌ openSettings "+e);} refreshState(); }

async function fullFlow(){
  await callInit();
  await callRequest();
  if(!BM.isBiometricTokenSaved){ document.getElementById("token").value="demo-token"; await callUpdate(); }
  await callAuth();
}
refreshState();
</script>
</body>
</html>
