<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAX WebApp Downloader</title>
  <script src="https://st.max.ru/js/max-web-app.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 16px; padding: 10px 20px; font-size: 1rem; }
    #log { margin-top: 20px; background: #f4f4f4; padding: 12px; border-radius: 6px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ MAX WebApp</h2>

<form id="downloadForm">
  <label for="url">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª (HTTPS):</label>
  <input type="url" id="url" placeholder="https://example.com/file.pdf" required />

  <label for="fileName">–ò–º—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:</label>
  <input type="text" id="fileName" placeholder="file.pdf" required />

  <button type="submit">–°–∫–∞—á–∞—Ç—å</button>
</form>

<div id="log">‚è≥ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...</div>

<script>
(function () {
  const logEl = document.getElementById('log');
  const form = document.getElementById('downloadForm');

  const log = msg => {
    console.log('[MAX]', msg);
    logEl.textContent = msg;
  };

  if (!window.WebApp) {
    log('‚ùå WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É MAX.');
    return;
  }

  window.WebApp.ready();

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const url = document.getElementById('url').value.trim();
    const fileName = document.getElementById('fileName').value.trim();

    if (!url.startsWith('https://')) {
      log('‚ùå URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://');
      return;
    }

    if (!fileName) {
      log('‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞');
      return;
    }

    const requestId = 'req-' + Date.now();

    try {
      window.WebApp.downloadFile({
        requestId,
        url,
        file_name: fileName
      });
      log(`üì§ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: ${fileName}`);
    } catch (err) {
      log('‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ downloadFile(): ' + err.message);
      return;
    }

    window.WebApp.onEvent(event => {
      if (!event || event.requestId !== requestId) return;

      if (event.status === 'downloading') {
        log(`‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å: ${fileName}`);
      } else if (event.status === 'cancelled') {
        log(`‚ö†Ô∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`);
      } else if (event.error) {
        const code = event.error.code;
        if (code === 'client.download_file.download_failed') {
          log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: download_failed');
        } else if (code === 'client.download_file.invalid_params') {
          log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: invalid_params (–Ω–µ–≤–µ—Ä–Ω—ã–π URL –∏–ª–∏ –∏–º—è —Ñ–∞–π–ª–∞)');
        } else {
          log(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ${code}`);
        }
      }
    });
  });
})();
</script>

</body>
</html>
