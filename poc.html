<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Show initData</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; padding:16px; background:#0b0f14; color:#e6edf3; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    h1 { margin:0 0 12px; font-size:20px; }
    .card { background:#0f1720; border:1px solid #1e293b; border-radius:12px; padding:16px; margin-bottom:12px; }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; white-space:pre-wrap; word-break:break-word; font-size:12px; }
    .muted { color:#94a3b8; font-size:12px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e6edf3; cursor:pointer; }
  </style>
</head>
<body>
  <h1>initData</h1>

  <div class="card">
    <div class="muted">Сырый initData</div>
    <pre id="raw" class="mono">—</pre>
    <div class="muted" style="margin-top:8px">Источник: <span id="source">—</span></div>
    <div style="margin-top:8px; display:flex; gap:8px;">
      <button id="copyBtn">Скопировать</button>
    </div>
  </div>

  <div class="card">
    <div class="muted">Разобранные параметры</div>
    <pre id="parsed" class="mono">—</pre>
  </div>

<script>
(function () {
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function waitBridge(maxMs = 2000) {
    const t0 = Date.now();
    while (Date.now() - t0 < maxMs) {
      if (window.WebApp && typeof window.WebApp.initData !== "undefined") return true;
      await sleep(50);
    }
    return false;
  }

  function detectInitData() {
    // 1) из MAX WebApp bridge
    if (typeof window.WebApp?.initData === "string" && window.WebApp.initData.length) {
      return { value: window.WebApp.initData, source: "WebApp.initData" };
    }
    // 2) фолбэк из URL для локальной проверки
    try {
      const usp = new URLSearchParams(location.search);
      const fromUrl = usp.get("initData");
      if (fromUrl) return { value: fromUrl, source: "URL ?initData=" };
    } catch {}
    return { value: "", source: "—" };
  }

  function parseInitDataString(str) {
    if (!str) return {};
    const params = new URLSearchParams(str);
    const obj = {};
    for (const [k, v] of params.entries()) {
      try { obj[k] = JSON.parse(v); } catch { obj[k] = v; }
    }
    return obj;
  }

  function render(raw, source) {
    document.getElementById("raw").textContent = raw || "—";
    document.getElementById("source").textContent = source;
    const parsed = parseInitDataString(raw);
    document.getElementById("parsed").textContent =
      Object.keys(parsed).length ? JSON.stringify(parsed, null, 2) : "—";
  }

  async function init() {
    await waitBridge(1200);            // дождаться моста MAX, если мы внутри MAX
    const { value, source } = detectInitData();
    render(value, source);
  }

  document.getElementById("copyBtn").addEventListener("click", async () => {
    const raw = document.getElementById("raw").textContent;
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(raw === "—" ? "" : raw);
        alert("Скопировано.");
      } else {
        // фолбэк
        const ta = document.createElement("textarea");
        ta.value = raw === "—" ? "" : raw;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        alert("Скопировано.");
      }
    } catch {
      alert("Не удалось скопировать.");
    }
  });

  init();
})();
</script>
</body>
</html>
